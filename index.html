<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game</title>
  <style>
    /* Dark flat design, spotify-inspired greens */
    :root{--bg:#121212;--panel:#181818;--green:#1db954;--green-dark:#17a44a;--purple:#7b1fa2;--muted:#bdbdbd}
    html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,system-ui,Arial,sans-serif}
    .app{max-width:480px;margin:0 auto;padding:18px;box-sizing:border-box;min-height:100vh;display:flex;flex-direction:column}
    .center{display:flex;flex-direction:column;align-items:center;justify-content:center}
    header{height:36px;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted)}
    #score{position:fixed;left:50%;transform:translateX(-50%);top:8px;font-size:12px;color:var(--muted);z-index:40}
    .card{background:var(--panel);padding:20px;border-radius:12px;box-shadow:none}
    input[type=text],input[type=password]{width:100%;padding:14px;border-radius:8px;border:none;background:#101010;color:#fff;font-size:18px}
    button{border:none;padding:14px 18px;border-radius:12px;font-size:18px;font-weight:600}
    .btn-green{background:var(--green);color:#000}
    .btn-green:active{background:var(--green-dark)}
    .btn-purple{background:var(--purple);color:#fff}
    .small{font-size:14px;color:var(--muted)}
    .row{display:flex;gap:12px}
    .large-circle{width:120px;height:120px;border-radius:999px;display:flex;align-items:center;justify-content:center;font-size:20px}
    .hidden{display:none}

    /* Lobby / teams layout */
    .teams{display:flex;gap:10px}
    .panel{flex:1;background:#0f0f0f;padding:12px;border-radius:10px;min-height:140px}
    .players-list{display:flex;flex-wrap:wrap;gap:8px}
    .player-pill{padding:8px 10px;border-radius:999px;background:#101010;font-size:14px;cursor:grab}

    /* categories */
    .categories{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .cat-btn{padding:14px;border-radius:10px;font-size:16px}
    .cat-disabled{opacity:0.3}

    /* playing */
    #countdown{font-size:48px;font-weight:700}
    #word{font-size:34px;margin:18px 0}

    /* verify list */
    .verify-grid{display:flex;flex-wrap:wrap;gap:8px}
    .verify-item{padding:8px 10px;border-radius:6px;background:#0f0f0f}

    /* confirmation */
    .confirm{display:flex;gap:10px}

    /* small mobile friendly adjustments */
    @media (max-width:420px){.large-circle{width:100px;height:100px}.row{flex-direction:column}}
  </style>
</head>
<body>
  <div id="score"></div>
  <div class="app center" id="app">
    <header> </header>

    <!-- SCREEN 1 - name device -->
    <div id="screen-name" class="card center">
      <input id="deviceName" type="text" placeholder="Nome do seu dispositivo" maxlength="20" />
      <div style="height:12px"></div>
      <button id="go2role" class="btn-green hidden">Avançar</button>
    </div>

    <!-- SCREEN 2 - role -->
    <div id="screen-role" class="card center hidden">
      <div style="display:flex;gap:12px;width:100%">
        <button id="btnVisitor" class="btn-green" style="flex:1">Visitante</button>
        <div style="width:12px"></div>
        <button id="btnAdmin" class="btn-purple" style="flex:1">Admin</button>
      </div>
      <div id="adminPassWrap" class="hidden" style="margin-top:12px;width:100%">
        <input id="adminPass" type="password" placeholder="Senha" />
      </div>
    </div>

    <!-- SCREEN 3 - teams (admin can drag) -->
    <div id="screen-teams" class="card hidden" style="width:100%">
      <div style="display:flex;gap:8px;margin-bottom:10px;align-items:center;justify-content:space-between">
        <div class="small">Lobby / Equipes</div>
        <div><button id="btnStartGame" class="btn-green">Iniciar</button></div>
      </div>
      <div class="teams">
        <div class="panel" id="lobbyPanel">
          <div class="small">Lobby</div>
          <div id="lobbyList" class="players-list"></div>
        </div>
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div class="small"><input id="team1Name" value="Equipe 1" style="background:transparent;border:none;color:#fff;font-weight:700;font-size:16px"/></div>
            <div class="small"> </div>
          </div>
          <div id="team1List" class="players-list" style="margin-top:8px"></div>
        </div>
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div class="small"><input id="team2Name" value="Equipe 2" style="background:transparent;border:none;color:#fff;font-weight:700;font-size:16px"/></div>
          </div>
          <div id="team2List" class="players-list" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <!-- SCREEN 4 - categories (admin only) -->
    <div id="screen-cats" class="card hidden" style="width:100%">
      <div class="categories" id="catsWrap"></div>
      <div style="height:12px"></div>
      <button id="btnFinish" class="btn-purple" style="width:100%">Finalizar</button>
    </div>

    <!-- SCREEN 5 - prepare -->
    <div id="screen-prepare" class="card hidden center">
      <div class="small">Preparar</div>
      <div id="prepareName" style="font-size:20px;font-weight:700;margin:12px 0"></div>
      <button id="btnBegin" class="btn-green">Iniciar</button>
    </div>

    <!-- SCREEN 6a - chosen player -->
    <div id="screen-playing-chosen" class="card hidden center">
      <div id="countdown">75</div>
      <div id="word">palavra</div>
      <div class="row">
        <button id="btnRight" class="large-circle btn-green">Acertou</button>
        <button id="btnSkip" class="large-circle" style="background:#b00020;color:#fff">Pular</button>
      </div>
      <div id="skipOverlay" class="hidden" style="position:absolute;left:0;right:0;top:0;bottom:0;display:flex;align-items:center;justify-content:center;font-size:20px;z-index:50">Pulando...</div>
    </div>

    <!-- SCREEN 6b - others -->
    <div id="screen-playing-others" class="card hidden center">
      <div id="countdown-other">75</div>
    </div>

    <!-- SCREEN 7 - verify -->
    <div id="screen-verify" class="card hidden" style="width:100%">
      <div class="small">Verificação</div>
      <div id="verifyGrid" class="verify-grid" style="margin-top:8px"></div>
      <div style="height:12px"></div>
      <button id="btnNextVerify" class="btn-green">Avançar</button>
    </div>

    <!-- confirm finalize -->
    <div id="screen-confirm" class="card hidden center">
      <div class="small">Deseja mesmo encerrar?</div>
      <div style="height:8px"></div>
      <div class="confirm"><button id="confirmYes" class="btn-purple">Sim</button><button id="confirmNo" class="btn-green">Não</button></div>
    </div>

    <!-- final -->
    <div id="screen-final" class="card hidden center">
      <div class="small">Placar Final</div>
      <div id="finalScore" style="margin-top:12px;font-size:20px"></div>
    </div>

  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let myId = null;
    let isAdmin = false;
    let myName = '';

    // UI elements
    const screenName = document.getElementById('screen-name');
    const deviceNameInput = document.getElementById('deviceName');
    const go2role = document.getElementById('go2role');
    const screenRole = document.getElementById('screen-role');
    const btnVisitor = document.getElementById('btnVisitor');
    const btnAdmin = document.getElementById('btnAdmin');
    const adminPassWrap = document.getElementById('adminPassWrap');
    const adminPass = document.getElementById('adminPass');

    const screenTeams = document.getElementById('screen-teams');
    const lobbyList = document.getElementById('lobbyList');
    const team1List = document.getElementById('team1List');
    const team2List = document.getElementById('team2List');
    const team1NameInput = document.getElementById('team1Name');
    const team2NameInput = document.getElementById('team2Name');
    const btnStartGame = document.getElementById('btnStartGame');

    const screenCats = document.getElementById('screen-cats');
    const catsWrap = document.getElementById('catsWrap');
    const btnFinish = document.getElementById('btnFinish');

    const screenPrepare = document.getElementById('screen-prepare');
    const prepareName = document.getElementById('prepareName');
    const btnBegin = document.getElementById('btnBegin');

    const screenPlayingChosen = document.getElementById('screen-playing-chosen');
    const screenPlayingOthers = document.getElementById('screen-playing-others');
    const countdown = document.getElementById('countdown');
    const countdownOther = document.getElementById('countdown-other');
    const wordNode = document.getElementById('word');
    const btnRight = document.getElementById('btnRight');
    const btnSkip = document.getElementById('btnSkip');
    const skipOverlay = document.getElementById('skipOverlay');

    const screenVerify = document.getElementById('screen-verify');
    const verifyGrid = document.getElementById('verifyGrid');
    const btnNextVerify = document.getElementById('btnNextVerify');

    const screenConfirm = document.getElementById('screen-confirm');
    const confirmYes = document.getElementById('confirmYes');
    const confirmNo = document.getElementById('confirmNo');

    const screenFinal = document.getElementById('screen-final');
    const finalScore = document.getElementById('finalScore');

    const scoreBox = document.getElementById('score');

    // initial UI
    deviceNameInput.addEventListener('input', () => {
      if (deviceNameInput.value.trim().length >= 2) go2role.classList.remove('hidden');
      else go2role.classList.add('hidden');
    });

    go2role.addEventListener('click', () => {
      myName = deviceNameInput.value.trim();
      showOnly(screenRole);
    });

    btnVisitor.addEventListener('click', () => {
      isAdmin = false; socket.emit('join', { name: myName, isAdmin: false }); showOnly(screenTeams);
    });

    btnAdmin.addEventListener('click', () => {
      adminPassWrap.classList.toggle('hidden');
    });

    adminPass.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') tryAdmin();
    });

    function tryAdmin() {
      const pw = adminPass.value || '';
      socket.emit('makeAdmin', { password: pw });
      isAdmin = true; // optimistically, server will reset but if password wrong server emits badPassword
    }

    socket.on('badPassword', () => { alert('Senha incorreta'); isAdmin=false; adminPass.value=''; });

    // drag & drop simplified: clicking a name toggles where it is (for mobile)
    function renderPlayers(state) {
      // clear
      lobbyList.innerHTML = '';
      team1List.innerHTML = '';
      team2List.innerHTML = '';

      state.lobby.forEach(p => {
        const el = document.createElement('div'); el.className = 'player-pill'; el.textContent = p.name; el.dataset.id = p.id;
        el.onclick = () => { if (isAdmin) socket.emit('moveToTeam', { playerId: p.id, team: 'team1' }); };
        lobbyList.appendChild(el);
      });

      state.teams.team1.forEach(p => {
        const el = document.createElement('div'); el.className = 'player-pill'; el.textContent = p.name; el.dataset.id = p.id;
        el.onclick = () => { if (isAdmin) socket.emit('moveToTeam', { playerId: p.id, team: 'team2' }); };
        team1List.appendChild(el);
      });

      state.teams.team2.forEach(p => {
        const el = document.createElement('div'); el.className = 'player-pill'; el.textContent = p.name; el.dataset.id = p.id;
        el.onclick = () => { if (isAdmin) socket.emit('moveToLobby', { playerId: p.id }); };
        team2List.appendChild(el);
      });

      team1NameInput.value = state.teamNames.team1 || 'Equipe 1';
      team2NameInput.value = state.teamNames.team2 || 'Equipe 2';

      team1NameInput.onchange = () => { if (isAdmin) socket.emit('setTeamName', { team: 'team1', name: team1NameInput.value }); };
      team2NameInput.onchange = () => { if (isAdmin) socket.emit('setTeamName', { team: 'team2', name: team2NameInput.value }); };

      // update score header
      scoreBox.textContent = `${state.scores.team1} — ${state.scores.team2}`;
    }

    btnStartGame.addEventListener('click', () => { if (!isAdmin) return; socket.emit('startCategories'); });

    // categories
    const CATS = ["animais","tv e cinema","objetos","lugares","pessoas","esportes e jogos","profissões","alimentos","personagens","bíblico"];
    function renderCategories(chosen) {
      catsWrap.innerHTML = '';
      CATS.forEach(cat => {
        const b = document.createElement('button'); b.textContent = cat; b.className = 'cat-btn btn-green';
        if (chosen && chosen.includes(cat)) { b.classList.add('cat-disabled'); b.disabled = true; }
        b.onclick = () => { if (!isAdmin) return; socket.emit('selectCategory', { category: cat }); };
        catsWrap.appendChild(b);
      });
    }

    btnFinish.addEventListener('click', () => { if (!isAdmin) return; showOnly(screenConfirm); });
    confirmNo.addEventListener('click', () => { socket.emit('finalizeConfirm', { confirm: false }); });
    confirmYes.addEventListener('click', () => { socket.emit('finalizeConfirm', { confirm: true }); });

    // prepare
    btnBegin.addEventListener('click', () => { socket.emit('beginTurn'); });

    // playing buttons
    btnRight.addEventListener('click', () => { socket.emit('gotIt'); });
    btnSkip.addEventListener('click', () => {
      // hide interface for 3s on chosen player only
      skipOverlay.classList.remove('hidden');
      document.querySelectorAll('#screen-playing-chosen > .row, #screen-playing-chosen > #word').forEach(n=>n?.classList?.add('hidden'));
      setTimeout(()=>{
        skipOverlay.classList.add('hidden');
        document.querySelectorAll('#screen-playing-chosen > .row, #screen-playing-chosen > #word').forEach(n=>n?.classList?.remove('hidden'));
      },3000);
      socket.emit('skip');
    });

    // verify next
    btnNextVerify.addEventListener('click', () => { if (!isAdmin) return; socket.emit('endVerifyNext'); });

    socket.on('state', (st) => { renderPlayers(st); });

    socket.on('phase', (data) => {
      const p = data.phase;
      if (p === 'categories') { renderCategories(data.categoryChosen || []); showOnly(screenCats); }
      if (p === 'verify') { showOnly(screenVerify); }
      if (p === 'final') { showOnly(screenFinal); finalScore.innerHTML = `Equipe 1: ${data.finalScores.team1}<br>Equipe 2: ${data.finalScores.team2}`; }
    });

    socket.on('categoryChosen', ({ category, phase }) => {
      // show prepare and notify chosen player via youAreChosen event
      showOnly(screenPrepare);
      prepareName.textContent = category; // category name displayed as requested
    });

    socket.on('youAreChosen', ({ name }) => {
      // personalize the prepare screen text
      prepareName.textContent = name;
      showOnly(screenPrepare);
    });

    socket.on('roundStart', (data) => {
      // chosen player will show chosen screen; others show countdown only
      if (data.chosenPlayer === socket.id) {
        showOnly(screenPlayingChosen);
      } else {
        showOnly(screenPlayingOthers);
      }
      updateRoundUI(data);
    });

    socket.on('timer', ({ t }) => {
      countdown.textContent = t;
      countdownOther.textContent = t;
      // hide skip when 5s or less
      if (t <= 5) btnSkip.classList.add('hidden'); else btnSkip.classList.remove('hidden');
    });

    socket.on('roundUpdate', (data) => {
      updateRoundUI(data);
    });

    socket.on('roundEnded', ({ roundWords, scores }) => {
      // show verify screen with words
      showOnly(screenVerify);
      renderVerify(roundWords);
      scoreBox.textContent = `${scores.team1} — ${scores.team2}`;
    });

    function updateRoundUI(data) {
      if (!data) return;
      countdown.textContent = data.timer || countdown.textContent;
      countdownOther.textContent = data.timer || countdownOther.textContent;
      wordNode.textContent = data.currentWord || '...';
      scoreBox.textContent = `${data.scores.team1} — ${data.scores.team2}`;
    }

    function renderVerify(roundWords) {
      verifyGrid.innerHTML = '';
      // Create items with color by status
      roundWords.forEach(r => {
        const el = document.createElement('div'); el.className = 'verify-item'; el.textContent = r.word;
        if (r.status === 'acertou') el.style.background = '#153f16';
        if (r.status === 'pulou') el.style.background = '#450b0b';
        verifyGrid.appendChild(el);
      });
      // try to force fit by adjusting font size depending on count
      const count = roundWords.length || 1;
      const size = Math.max(12, 28 - Math.floor(count / 2));
      verifyGrid.style.fontSize = size + 'px';
    }

    socket.on('categoryChosen', () => {});

    // utilities
    function showOnly(el) {
      const screens = [screenName, screenRole, screenTeams, screenCats, screenPrepare, screenPlayingChosen, screenPlayingOthers, screenVerify, screenConfirm, screenFinal];
      screens.forEach(s => s.classList.add('hidden'));
      el.classList.remove('hidden');
    }

    // initial setup
    showOnly(screenName);
    renderCategories([]);

    // beforeunload warning
    window.addEventListener('beforeunload', function (e) {
      e.preventDefault();
      e.returnValue = '';
    });

    // small helper to set our socket id
    socket.on('connect', () => { myId = socket.id; });
  </script>
</body>
</html>